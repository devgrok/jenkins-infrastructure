Description: >
    This template contains the security groups required by our entire stack.
    We create them in a seperate nested template, so they can be referenced
    by all of the other nested templates.

Parameters:
    
    EnvironmentName:
        Description: An environment name that will be prefixed to resource names
        Type: String
    
    VPC:
        Type: AWS::EC2::VPC::Id
        Description: Choose which VPC the security groups should be deployed to

    VpcCIDR:
        Type: String
        Description: The VPC CIDR block

Resources:

    # This security group defines who/where is allowed to access the ECS hosts directly.
    # By default we're just allowing access from the load balancer.  If you want to SSH 
    # into the hosts, or expose non-load balanced services you can open their ports here.
    MasterHostSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            VpcId: !Ref VPC
            GroupDescription: Access to the ECS hosts and the tasks/containers that run on them
            SecurityGroupIngress:
                # Only allow inbound access to ECS from the ELB
                -   SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
                    IpProtocol: -1
                    Description: all access from load balancer
                -   IpProtocol: tcp
                    FromPort: '22'
                    ToPort: '22'
                    CidrIp: !Ref VpcCIDR
                    Description: ssh access from VPC for debugging
            Tags:
                -   Key: Name
                    Value: !Sub ${EnvironmentName}-ECS-Hosts

    # This security group defines who/where is allowed to access the Application Load Balancer.
    # By default, we've opened this up to the public internet (0.0.0.0/0) but can you restrict
    # it further if you want.
    LoadBalancerSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            VpcId: !Ref VPC
            GroupDescription: Access to the load balancer that sits in front of ECS
            SecurityGroupIngress:
                -   IpProtocol: tcp
                    FromPort: '80'
                    ToPort: '80'
                    CidrIp: !Ref VpcCIDR
                -   IpProtocol: tcp
                    FromPort: '443'
                    ToPort: '443'
                    CidrIp: !Ref VpcCIDR
                -   IpProtocol: tcp
                    FromPort: '50000'
                    ToPort: '50000'
                    CidrIp: !Ref VpcCIDR
            Tags:
                -   Key: Name
                    Value: !Sub ${EnvironmentName}-LoadBalancers

    EFSMountTargetSecurityGroup:
        Type: "AWS::EC2::SecurityGroup"
        Properties:
            VpcId: !Ref VPC
            GroupDescription: "Security group to allow inbound NFS for EFS mount target from ECS container instances"
            SecurityGroupIngress:
                -   IpProtocol: "tcp"
                    FromPort: "2049"
                    ToPort: "2049"
                    CidrIp: !Ref VpcCIDR


    SlaveHostSecurityGroup:
        Type: 'AWS::EC2::SecurityGroup'
        Properties:
            GroupName: 'jenkins-slave'
            GroupDescription: 'SecurityGroup for Jenkins instances: slave'
            VpcId: !Ref VPC
            SecurityGroupIngress:
                -   IpProtocol: tcp
                    FromPort: '22'
                    ToPort: '22'
                    CidrIp: !Ref VpcCIDR
                    Description: ssh access from VPC for debugging
                -   IpProtocol: tcp
                    FromPort: '0'
                    ToPort: '65535'
                    SourceSecurityGroupId: !Ref MasterHostSecurityGroup
                    Description: access all tcp from master to slave
                -   IpProtocol: icmp
                    FromPort: '-1'
                    ToPort: '-1'
                    CidrIp: 0.0.0.0/0
                    Description: PING default everywhere
Outputs:

    MasterHostSecurityGroup:
        Description: A reference to the security group for Jenkins Master ECS hosts
        Value: !Ref MasterHostSecurityGroup

    SlaveHostSecurityGroup:
        Description: A reference to the security group for Jenkins Slaves ECS hosts
        Value: !Ref SlaveHostSecurityGroup

    LoadBalancerSecurityGroup:
        Description: A reference to the security group for load balancers
        Value: !Ref LoadBalancerSecurityGroup
    
    EFSMountTargetSecurityGroup:
        Description: A reference to the security group for ECS hosts to access EFS
        Value: !Ref EFSMountTargetSecurityGroup

